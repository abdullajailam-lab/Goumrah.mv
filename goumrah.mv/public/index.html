<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GEMS Milandhoo School Portal — Pro</title>
    <!-- CDNs -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Your existing CSS remains unchanged */
        :root{
            --sidebar-a:#06283d; --sidebar-b:#0aa3a3; --accent:#ffd166;
            --card:#ffffff; --muted:#6b7c93; --success:#2ea44f; --danger:#ef5350;
            --radius:12px; --shadow:0 10px 30px rgba(2,6,23,0.12);
            --input-text:#000; --ink:#072031; --bg:#eef6f9;
        }
        *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
        html,body{height:100%;margin:0;background:var(--bg);color:var(--ink)}
        /* App shell */
        .app{display:flex;height:100vh;overflow:hidden}
        .sidebar{
            width:280px;padding:22px;background:linear-gradient(180deg,var(--sidebar-a),var(--sidebar-b));
            color:#fff;display:flex;flex-direction:column;gap:18px;box-shadow:var(--shadow)
        }
        .brand{display:flex;align-items:center;gap:12px}
        .brand .logo{width:48px;height:48px;border-radius:10px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center}
        .brand h1{margin:0;font-size:18px;font-weight:800}
        .nav{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px}
        .nav button{background:transparent;border:none;color:#e9fbfb;padding:12px;border-radius:10px;text-align:left;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .15s}
        .nav button:hover{background:rgba(255,255,255,0.06);transform:translateX(6px)}
        .main{flex:1;padding:20px;overflow:auto}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .title{font-weight:800;font-size:20px;color:#072031}
        .header .note{color:var(--muted)}
        .row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
        .card{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);min-width:160px}
        .big{font-size:20px;font-weight:900;color:#052235}
        .small-note{font-size:13px;color:var(--muted)}
        /* panels & forms */
        .panel{background:#fff;padding:14px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:14px}
        .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
        input[type="text"], input[type="date"], input[type="time"], input[type="number"], select, textarea{
            padding:10px;border-radius:10px;border:1px solid #d8e6ee;background:#fff;color:var(--input-text);min-width:160px;font-size:13px;
        }
        textarea{min-height:80px;resize:vertical}
        .btn{padding:10px 12px;border-radius:10px;border:none;background:var(--accent);font-weight:800;cursor:pointer}
        .btn.secondary{background:transparent;border:1px solid #cfdce8}
        .small{padding:8px 10px;font-size:13px;border-radius:8px}
        .table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
        .table th,.table td{padding:10px;border:1px solid #eef4f8;text-align:left;font-size:13px}
        /* section accents */
        .section-att .panel{border-left:6px solid #000}
        .section-meet .panel{border-left:6px solid #000}
        .section-less .panel{border-left:6px solid #000}
        /* ensure inputs have black text */
        .section-att input, .section-att textarea, .section-att select,
        .section-meet input, .section-meet textarea, .section-meet select,
        .section-less input, .section-less textarea, .section-less select { color:#000;background:#fff;border:1px solid #c6d3df; }
        /* action buttons */
        .action-btn{padding:6px 10px;border-radius:8px;color:#fff;border:none;cursor:pointer}
        .edit{background:var(--success)}
        .del{background:var(--danger)}
        .link{background:#5b76ff}
        .hidden{display:none}
        .note{color:var(--muted);font-size:13px}
        @media (max-width:900px){ .sidebar{display:none} .app{flex-direction:column} }
        /* pill badges */
        .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #cfe0ea;font-size:12px;color:#375a74;background:#f6fbfe}
        /* Auth status messs */
        .auth-status {
            padding: 8px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }
        .auth-success {
            background-color: rgba(46, 164, 79, 0.2);
            color: #2ea44f;
        }
        .auth-error {
            background-color: rgba(239, 83, 80, 0.2);
            color: #ef5350;
        }
        /* Loading indicator */
        .loading {display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-left: 10px;}
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Fix for login/register buttons */
        #btnLogin, #btnRegister {
            transition: all 0.2s ease;
        }
        #btnLogin:hover, #btnRegister:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #btnLogin:active, #btnRegister:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- LOGIN / REGISTER -->
    <div id="authScreen" style="position:fixed;inset:0;background:linear-gradient(135deg,#071a2b 0%,#0a8b8b 100%);display:flex;align-items:center;justify-content:center;z-index:999">
        <div style="width:480px;max-width:90vw;background:rgba(255,255,255,0.1);padding:32px;border-radius:16px;color:#fff;box-shadow:0 20px 50px rgba(0,0,0,0.3);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.15)">
            <div style="text-align:center;margin-bottom:24px">
                <div style="width:72px;height:72px;background:rgba(255,255,255,0.1);border-radius:20px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px">
                    <svg viewBox="0 0 24 24" width="32" height="32" style="filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))">
                        <path d="M12 2 L22 8 L17 22 L7 22 L2 8 Z" fill="white" opacity="0.8" />
                        <path d="M12 6 L16 10 L12 14 L8 10 Z" fill="white" />
                    </svg>
                </div>
                <h2 style="margin:0 0 8px 0;font-size:24px;font-weight:800;text-shadow:0 2px 4px rgba(0,0,0,0.3)">GEMS Milandhoo</h2>
                <p style="margin:0;color:rgba(255,255,255,0.8);font-size:15px">School Portal Pro</p>
            </div>
            
            <div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center">
                <div style="flex:1;min-width:240px;background:rgba(255,255,255,0.1);padding:24px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(5px)">
                    <h3 style="margin:0 0 20px 0;font-size:18px;font-weight:700;display:flex;align-items:center;gap:8px">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:#ffd166">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Login
                    </h3>
                    <div style="display:flex;flex-direction:column;gap:12px">
                        <div style="position:relative">
                            <input id="loginEmail" placeholder="Email address" type="email" style="width:100%;padding:12px 14px;border-radius:10px;border:none;background:rgba(255,255,255,0.15);color:white;outline:none;transition:all 0.3s" />
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,0.6)">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                <polyline points="22,6 12,13 2,6"></polyline>
                            </svg>
                        </div>
                        <div style="position:relative">
                            <input id="loginPass" placeholder="Password" type="password" style="width:100%;padding:12px 14px;border-radius:10px;border:none;background:rgba(255,255,255,0.15);color:white;outline:none;transition:all 0.3s" />
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,0.6)">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        </div>
                        <button id="btnLogin" style="width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(45deg,#ffd166, #ffea8a);font-weight:700;color:#000;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 15px rgba(255,209,102,0.3);font-size:15px">
                            Sign In
                        </button>
                        <div id="loginStatus" class="auth-status"></div>
                    </div>
                </div>
                
                <div style="flex:1;min-width:240px;background:rgba(255,255,255,0.1);padding:24px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(5px)">
                    <h3 style="margin:0 0 20px 0;font-size:18px;font-weight:700;display:flex;align-items:center;gap:8px">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:#4ce0c9">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Register
                    </h3>
                    <div style="display:flex;flex-direction:column;gap:12px">
                        <input id="regName" placeholder="Full Name" style="width:100%;padding:12px 14px;border-radius:10px;border:none;background:rgba(255,255,255,0.15);color:white;outline:none;transition:all 0.3s" />
                        <input id="regEmail" placeholder="Email address" type="email" style="width:100%;padding:12px 14px;border-radius:10px;border:none;background:rgba(255,255,255,0.15);color:white;outline:none;transition:all 0.3s" />
                        <input id="regPass" placeholder="Password (min 6 characters)" type="password" style="width:100%;padding:12px 14px;border-radius:10px;border:none;background:rgba(255,255,255,0.15);color:white;outline:none;transition:all 0.3s" />
                        <button id="btnRegister" style="width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(45deg,#4ce0c9, #66f0d9);font-weight:700;color:#003;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 15px rgba(76,224,201,0.3);font-size:15px">
                            Create Account
                        </button>
                        <div id="registerStatus" class="auth-status"></div>
                    </div>
                </div>
            </div>
            
            <p style="text-align:center;margin-top:24px;color:rgba(255,255,255,0.7);font-size:14px;line-height:1.5">
                <small>Secure access for teachers only. All data is encrypted and shared with authorized staff.</small>
            </p>
        </div>
    </div>
    <!-- APP -->
    <div class="app" id="appRoot" style="display:none">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <div class="logo" aria-hidden>
                    <svg viewBox="0 0 24 24" width="22" height="22"><path d="M12 2 L22 8 L17 22 L7 22 L2 8 Z" fill="white" opacity="0.12" /></svg>
                </div>
                <div>
                    <h1>GEMS Milandhoo</h1>
                    <div class="small-note">School Portal</div>
                </div>
            </div>
            <nav>
                <ul class="nav">
                    <li><button onclick="navigate('dashboard')">🏠 Dashboard</button></li>
                    <li><button onclick="navigate('students')">👥 Students</button></li>
                    <li><button onclick="navigate('attendance')">📋 Attendance</button></li>
                    <li><button onclick="navigate('meetings')">🗒️ Meeting Minutes</button></li>
                    <li><button onclick="navigate('lessons')">📚 Lesson Plans</button></li>
                    <li style="margin-top:12px"><button onclick="logout()" style="background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff;padding:10px;border-radius:8px">Logout</button></li>
                </ul>
            </nav>
            <div style="margin-top:auto">
                <div class="small-note">Logged in as</div>
                <div id="currentUser" style="font-weight:800"></div>
                <div id="saveStatus" class="small-note"></div>
            </div>
        </aside>
        <!-- Main -->
        <main class="main">
            <div class="header">
                <div class="title">GEMS Milandhoo School Portal</div>
                <div class="note" id="currentTime">--</div>
            </div>
            <!-- DASHBOARD -->
            <section id="dashboard" class="card">
                <div style="display:flex;gap:12px;flex-wrap:wrap">
                    <div class="card"><div class="big" id="totalStudents">0</div><div class="small-note">Students</div></div>
                    <div class="card"><div class="big" id="attendanceDays">0</div><div class="small-note">Attendance Days</div></div>
                    <div class="card"><div class="big" id="meetingsCount">0</div><div class="small-note">Meetings</div></div>
                    <div class="card"><div class="big" id="lessonsCount">0</div><div class="small-note">Lesson Plans</div></div>
                </div>
                <div class="panel" style="margin-top:12px">
                    <h3 style="margin:0 0 8px 0">Overview</h3>
                    <p class="small-note">Use the sidebar to man Students, Attendance, Meeting Minutes and Lesson Plans. All records are saved to the cloud and shared with all teachers.</p>
                </div>
            </section>
            <!-- STUDENTS -->
            <section id="students" class="hidden">
                <div class="panel">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><h3 style="margin:0">Students Manment</h3><div class="small-note">Add / Edit / Delete students</div></div>
                        <div id="studentEditingBadge" class="small-note hidden" style="color:#b55">Editing...</div>
                    </div>
                    <form id="studentForm" style="margin-top:12px">
                        <div class="controls">
                            <input id="stuName" placeholder="Full name" required>
                            <input id="stuAge" type="number" placeholder="Age" min="3">
                            <input id="stuGrade" placeholder="Grade">
                            <input id="stuLevel" placeholder="Level">
                            <button class="btn" type="submit">Add / Save</button>
                            <button id="cancelStudent" class="btn secondary" type="button" style="display:none" onclick="cancelEdit('student')">Cancel</button>
                        </div>
                    </form>
                </div>
                <div class="panel">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <div><strong>Students List</strong><div class="small-note">Search & manage students below</div></div>
                        <div class="controls">
                            <input id="studentSearch" placeholder="Search name or grade" oninput="renderStudents()">
                            <button class="small" onclick="exportStudentsCSV()">Export CSV</button>
                        </div>
                    </div>
                    <table class="table" id="studentsTable">
                        <thead><tr><th>Name</th><th>Age</th><th>Grade</th><th>Level</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
            <!-- ATTENDANCE -->
            <section id="attendance" class="hidden section-att">
                <div class="panel">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><h3 style="margin:0">Attendance</h3><div class="small-note">Black-text fields for clarity</div></div>
                        <div class="controls">
                            <label>Start <input id="attStart" type="date"></label>
                            <label>End <input id="attEnd" type="date"></label>
                            <button class="small" onclick="loadAttendanceRange()">Load Range</button>
                            <button class="small" onclick="exportAttendanceExcel()">Export Excel</button>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="controls">
                        <label>Date <input id="attDate" type="date"></label>
                        <button class="small" onclick="loadAttendanceForDate()">Load Students</button>
                        <button class="small" onclick="saveAttendance()">Save Attendance</button>
                        <div style="margin-left:auto;display:flex;gap:8px">
                            <button class="small" onclick="markAll('Present')">All Present</button>
                            <button class="small" onclick="markAll('Absent')">All Absent</button>
                            <button class="small" onclick="markAll('Holiday')">All Holiday</button>
                        </div>
                    </div>
                    <div class="small-note" style="margin-top:8px">Pick a date, click Load Students, mark statuses, then Save Attendance.</div>
                </div>
                <div class="panel">
                    <table class="table" id="attendanceTable">
                        <thead><tr><th>Date</th><th>Student</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
            <!-- MEETINGS (Pro) -->
            <section id="meetings" class="hidden section-meet">
                <div class="panel">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><h3 style="margin:0">Meeting Minutes</h3><div class="small-note">Professional fields & PDF export</div></div>
                        <div class="controls">
                            <label>Start <input id="mtStart" type="date"></label>
                            <label>End <input id="mtEnd" type="date"></label>
                            <button class="small" onclick="loadMeetingsRange()">Load Range</button>
                            <button class="small" onclick="exportMeetingsRangePDF()">Export Range (PDF)</button>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <form id="meetingForm">
                        <div class="controls">
                            <input id="mtDate" type="date" required>
                            <input id="mtStartTime" type="time" placeholder="Start time">
                            <input id="mtEndTime" type="time" placeholder="End time">
                            <input id="mtTitle" type="text" placeholder="Meeting Title" required>
                            <input id="mtLocation" type="text" placeholder="Location">
                        </div>
                        <div class="controls" style="margin-top:8px">
                            <input id="mtChair" type="text" placeholder="Leading Teacher">
                            <select id="mtParticipants" multiple style="min-width:220px;max-height:110px;overflow:auto"></select>
                            <input id="mtParticipantsFree" type="text" placeholder="Extra participants (comma separated)">
                        </div>
                        <div style="margin-top:8px;display:flex;gap:12px;flex-wrap:wrap">
                            <textarea id="mtAgenda" placeholder="Agenda (bullet points or text)" style="min-height:120px"></textarea>
                            <textarea id="mtDecisions" placeholder="Key Decisions" style="min-height:120px"></textarea>
                        </div>
                        <div style="margin-top:8px">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><strong>Action Items</strong><span class="badge">owner + due + status</span></div>
                            <div class="controls">
                                <input id="aiText" type="text" placeholder="Action item description">
                                <input id="aiOwner" type="text" placeholder="Owner">
                                <input id="aiDue" type="date">
                                <select id="aiStatus">
                                    <option value="Open">Open</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Done">Done</option>
                                </select>
                                <button class="small" type="button" onclick="addActionItem()">Add</button>
                            </div>
                            <table class="table" id="actionsTable" style="margin-top:8px">
                                <thead><tr><th>#</th><th>Description</th><th>Owner</th><th>Due</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div style="margin-top:8px;display-flex;gap:8px">
                            <button class="btn" type="submit">Add / Save Meeting</button>
                            <button id="cancelMeeting" class="btn secondary" type="button" style="display:none" onclick="cancelEdit('meeting')">Cancel</button>
                        </div>
                    </form>
                </div>
                <div class="panel">
                    <table class="table" id="meetingsTable">
                        <thead><tr><th>Date</th><th>Title</th><th>Participants</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
            <!-- LESSONS -->
            <section id="lessons" class="hidden section-less">
                <div class="panel">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><h3 style="margin:0">Lesson Plans</h3><div class="small-note">Black-text fields — export to boxed template PDF</div></div>
                        <div class="controls">
                            <label>Start <input id="lsStart" type="date"></label>
                            <label>End <input id="lsEnd" type="date"></label>
                            <button class="small" onclick="loadLessonsRange()">Load Range</button>
                            <button class="small"onclick="exportLessonsPDF()">Export Lesson Plans (PDF)</button>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <form id="lessonForm">
                        <div class="controls">
                            <input id="lsDate" type="date" required>
                            <select id="lsStudent" required style="min-width:220px"><option value="">-- choose student--</option></select>
                            <input id="lsSubject" placeholder="Subject / Course" required>
                            <input id="lsTopic" placeholder="Name of Lesson"required>
                        </div>
                        <div style="margin-top:10px">
                            <textarea id="lsObjectives" placeholder="Objectives / General description" style="width:100%;min-height:100px"></textarea>
                        </div>
                        <div style="margin-top:10px;display-flex;gap:12px;flex-wrap:wrap">
                            <textarea id="lsMaterials" placeholder="Materials" style="flex:1;min-width:260px"></textarea>
                            <textarea id="lsActivities" placeholder="Activities" style="flex:1;min-width:260px"></textarea>
                        </div>
                        <div style="margin-top:10px">
                            <textarea id="lsHomework" placeholder="Homework" style="width:100%;min-height:60px"></textarea>
                            <div style="margin-top:8px;display-flex;gap:8px">
                                <button class="btn" type="submit">Add / Save Lesson</button>
                                <button id="cancelLesson" class="btn secondary" type="button" style="display:none"onclick="cancelEdit('lesson')">Cancel</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="panel">
                    <table class="table" id="lessonsTable">
                        <thead><tr><th>Date</th><th>Student</th><th>Subject</th><th>Lesson</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>
    <script>
        // Initialize Supabase with correct API key
        let SUPABASE_URL = "https://sasodvdokwybanovtuwl.supabase.co";
        let SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhc29kdmRva3d5YmFub3Z0dXdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzMzNTAsImV4cCI6MjA3MDc0OTM1MH0.sUJx73vkjPlKo9m8De6dUNGMcdWjb1vh8hnsMBVMgRQ";
        // Create Supabase client
        let supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        // Global state
        let currentUser = null;
        let currentData = {
            students: [],
            attendance: [],
            meetings: [],
            lessons: []
        };
        let editingStudent = null;
        let editingMeeting = null;
        let editingLesson = null;
        let actionItems = [];
        let currentAttendanceDate = null;
        /* -------------------------
           AUTHENTICATION
        ------------------------- */
        async function setupAuth() {
            // Check for existing session
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    openApp();
                }
                // Listen for auth changes
                supabase.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'SIGNED_IN' && session) {
                        currentUser = session.user;
                        openApp();
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        location.reload();
                    }
                });
            } catch (error) {
                console.error('Error setting up auth:', error);
                document.getElementById('loginStatus').textContent = 'Error connecting to Supabase. Please check your API key.';
                document.getElementById('loginStatus').className = 'auth-status auth-error';
            }
            // Bind auth buttons - FIXED: Added proper event listeners
            document.getElementById('btnLogin').addEventListener('click', login);
            document.getElementById('btnRegister').addEventListener('click', register);
            // Also allow form submission with Enter key
            document.getElementById('loginEmail').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            document.getElementById('loginPass').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            document.getElementById('regName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') register();
            });
            document.getElementById('regEmail').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') register();
            });
            document.getElementById('regPass').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') register();
            });
        }
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPass').value;
            const status = document.getElementById('loginStatus');
            if (!email || !password) {
                status.textContent = 'Please enter email and password';
                status.className = 'auth-status auth-error';
                return;
            }
            status.textContent = 'Logging in...';
            status.className = 'auth-status';
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                if (error) {
                    status.textContent = error.message;
                    status.className = 'auth-status auth-error';
                } else {
                    status.textContent = 'Login successful!';
                    status.className = 'auth-status auth-success';
                    currentUser = data.user;
                }
            } catch (error) {
                status.textContent = 'Login failed. Please try again.';
                status.className = 'auth-status auth-error';
                console.error('Login error:', error);
            }
        }
        async function register() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPass').value;
            const status = document.getElementById('registerStatus');
            if (!name || !email || !password) {
                status.textContent = 'Please fill all fields';
                status.className = 'auth-status auth-error';
                return;
            }
            if (password.length < 6) {
                status.textContent = 'Password must be at least 6 characters';
                status.className = 'auth-status auth-error';
                return;
            }
            status.textContent = 'Creating account...';
            status.className = 'auth-status';
            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: name
                        }
                    }
                });
                if (error) {
                    status.textContent = error.message;
                    status.className = 'auth-status auth-error';
                } else {
                    status.textContent = 'Account created! Please check your email for confirmation.';
                    status.className = 'auth-status auth-success';
                    // Auto login after registration
                    const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });
                    if (loginError) {
                        status.textContent = 'Account created but automatic login failed. Please login manually.';
                    } else {
                        currentUser = loginData.user;
                    }
                }
            } catch (error) {
                status.textContent = 'Registration failed. Please try again.';
                status.className = 'auth-status auth-error';
                console.error('Registration error:', error);
            }
        }
        async function logout() {
            await supabase.auth.signOut();
        }
        /* -------------------------
           DATA MANAGEMENT
        ------------------------- */
        async function loadAllData() {
            await Promise.all([
                loadStudents(),
                loadAttendance(),
                loadMeetings(),
                loadLessons()
            ]);
            refreshAll();
        }
        async function loadStudents() {
            try {
                const { data, error } = await supabase
                    .from('students')
                    .select('*')
                    .order('name');
                if (error) {
                    console.error('Error loading students:', error);
                    showStatus('Error loading students','error');
                } else {
                    currentData.students = data || [];
                    populateStudentSelect();
                    populateParticipantSelect();
                }
            } catch (error) {
                console.error('Error loading students:', error);
                showStatus('Error loading students','error');
            }
        }
        async function saveStudents() {
            try {
                if (editingStudent !== null) {
                    // Update existing student
                    const studentId = currentData.students[editingStudent].id;
                    const studentData = {
                        name: document.getElementById('stuName').value.trim(),
                        age: parseInt(document.getElementById('stuAge').value) || 0,
                        grade: document.getElementById('stuGrade').value.trim(),
                        level: document.getElementById('stuLevel').value.trim()
                    };
                    const { error } = await supabase
                        .from('students')
                        .update(studentData)
                        .eq('id', studentId);
                    if (error) {
                        console.error('Error updating student:', error);
                        showStatus('Error updating student', 'error');
                        return false;
                    }
                } else {
                    // Add new student
                    const studentData = {
                        name: document.getElementById('stuName').value.trim(),
                        age: parseInt(document.getElementById('stuAge').value) || 0,
                        grade: document.getElementById('stuGrade').value.trim(),
                        level: document.getElementById('stuLevel').value.trim()
                    };
                    const { error } = await supabase
                        .from('students')
                        .insert([studentData]);
                    if (error) {
                        console.error('Error saving student:', error);
                        showStatus('Error saving student', 'error');
                        return false;
                    }
                }
                // Reload students data
                await loadStudents();
                return true;
            } catch (error) {
                console.error('Error saving students:', error);
                showStatus('Error saving students', 'error');
                return false;
            }
        }
        async function loadAttendance() {
            try {
                const { data, error } = await supabase
                    .from('attendance')
                    .select('*')
                    .order('date',{ascending:false});
                if (error) {
                    console.error('Error loading attendance:',error);
                    showStatus('Error loading attendance','error');
                } else {
                    currentData.attendance = data || [];
                }
            } catch (error) {
                console.error('Error loading attendance:',error);
                showStatus('Error loading attendance','error');
            }
        }
        async function saveAttendance() {
    try {
        // Get the current date
        const date = document.getElementById('attDate').value;
        if (!date) {
            showStatus('Please select a date first', 'error');
            return false;
        }
        
        // Get all attendance records for this date
        const attendanceRecords = [];
        const rows = document.querySelectorAll('#attendanceTable tbody tr');
        
        rows.forEach(row => {
            const studentName = row.cells[1].textContent;
            const statusSelect = row.querySelector('select');
            const status = statusSelect ? statusSelect.value : 'Absent';
            
            attendanceRecords.push({
                date,
                student: studentName,
                status
            });
        });

        // Delete existing records for this date
        const { error: deleteError } = await supabase
            .from('attendance')
            .delete()
            .eq('date', date);
            
        if (deleteError) {
            console.error('Error deleting attendance:', deleteError);
            showStatus('Error clearing previous attendance', 'error');
            return false;
        }

        // Insert new records in batches to avoid Supabase limits
        if (attendanceRecords.length > 0) {
            // Split into batches of 50 records (Supabase recommends batches of 100-1000)
            const batchSize = 50;
            for (let i = 0; i < attendanceRecords.length; i += batchSize) {
                const batch = attendanceRecords.slice(i, i + batchSize);
                
                const { error } = await supabase
                    .from('attendance')
                    .insert(batch);
                    
                if (error) {
                    console.error('Error saving attendance batch:', error);
                    showStatus('Error saving attendance', 'error');
                    return false;
                }
            }
        }

        // Reload attendance data
        await loadAttendance();
        showStatus('Attendance saved successfully');
        return true;
    } catch (error) {
        console.error('Error saving attendance:', error);
        showStatus('Error saving attendance', 'error');
        return false;
    }
}
        async function loadMeetings() {
            try {
                const { data, error } = await supabase
                    .from('meetings')
                    .select('*')
                    .order('date',{ascending:false});
                if (error) {
                    console.error('Error loading meetings:',error);
                    showStatus('Error loading meetings','error');
                } else {
                    currentData.meetings = data || [];
                }
            } catch (error) {
                console.error('Error loading meetings:',error);
                showStatus('Error loading meetings','error');
            }
        }
        async function saveMeetings() {
            try {
                const meetingData = {
                    date: document.getElementById('mtDate').value,
                    start_time: document.getElementById('mtStartTime').value,
                    end_time: document.getElementById('mtEndTime').value,
                    title: document.getElementById('mtTitle').value.trim(),
                    location: document.getElementById('mtLocation').value.trim(),
                    chair: document.getElementById('mtChair').value.trim(),
                    participants: document.getElementById('mtParticipantsFree').value
                        .split(',')
                        .map(p => p.trim())
                        .filter(p => p),
                    agenda: document.getElementById('mtAgenda').value.trim(),
                    decisions: document.getElementById('mtDecisions').value.trim(),
                    actions: actionItems
                };
                // Add selected participants from the multi-select
                Array.from(document.getElementById('mtParticipants').selectedOptions).forEach(option => {
                    meetingData.participants.push(option.value);
                });
                if (editingMeeting !== null) {
                    // Update existing meeting
                    const meetingId = currentData.meetings[editingMeeting].id;
                    const { error } = await supabase
                        .from('meetings')
                        .update(meetingData)
                        .eq('id',meetingId);
                    if (error) {
                        console.error('Error updating meeting:',error);
                        showStatus('Error updating meeting','error');
                        return false;
                    }
                } else {
                    // Add new meeting
                    const { error } = await supabase
                        .from('meetings')
                        .insert([meetingData]);
                    if (error) {
                        console.error('Error saving meeting:',error);
                        showStatus('Error saving meeting','error');
                        return false;
                    }
                }
                // Reload meetings data
                await loadMeetings();
                return true;
            } catch (error) {
                console.error('Error saving meetings:',error);
                showStatus('Error saving meetings','error');
                return false;
            }
        }
        async function loadLessons() {
            try {
                const { data, error } = await supabase
                    .from('lessons')
                    .select('*')
                    .order('date',{ascending:false});
                if (error) {
                    console.error('Error loading lessons:',error);
                    showStatus('Error loading lessons','error');
                } else {
                    currentData.lessons = data || [];
                }
            } catch (error) {
                console.error('Error loading lessons:',error);
                showStatus('Error loading lessons','error');
            }
        }
        async function saveLessons() {
            try {
                const lessonData = {
                    date: document.getElementById('lsDate').value,
                    student: document.getElementById('lsStudent').value,
                    subject: document.getElementById('lsSubject').value.trim(),
                    topic: document.getElementById('lsTopic').value.trim(),
                    objectives: document.getElementById('lsObjectives').value.trim(),
                    materials: document.getElementById('lsMaterials').value.trim(),
                    activities: document.getElementById('lsActivities').value.trim(),
                    homework: document.getElementById('lsHomework').value.trim()
                };
                if (editingLesson !== null) {
                    // Update existing lesson
                    const lessonId = currentData.lessons[editingLesson].id;
                    const { error } = await supabase
                        .from('lessons')
                        .update(lessonData)
                        .eq('id',lessonId);
                    if (error) {
                        console.error('Error updating lesson:',error);
                        showStatus('Error updating lesson','error');
                        return false;
                    }
                } else {
                    // Add new lesson
                    const { error } = await supabase
                        .from('lessons')
                        .insert([lessonData]);
                    if (error) {
                        console.error('Error saving lesson:',error);
                        showStatus('Error saving lesson','error');
                        return false;
                    }
                }
                // Reload lessons data
                await loadLessons();
                return true;
            } catch (error) {
                console.error('Error saving lessons:',error);
                showStatus('Error saving lessons','error');
                return false;
            }
        }
        function setupRealtimeUpdates() {
            // Set up realtime subscriptions for each table
            const channels = [
                supabase.channel('students-changes')
                    .on('postgres_changes', 
                        { event: '*', schema:'public',table:'students' }, 
                        () => loadStudents().then(renderStudents)
                    )
                    .subscribe(),
                supabase.channel('attendance-changes')
                    .on('postgres_changes', 
                        { event: '*',schema:'public',table:'attendance' }, 
                        () => loadAttendance().then(renderAttendanceForDate)
                    )
                    .subscribe(),                
                supabase.channel('meetings-changes')
                    .on('postgres_changes', 
                        { event: '*',schema:'public',table:'meetings' }, 
                        () => loadMeetings().then(renderMeetingsRange)
                    )
                    .subscribe(),                
                supabase.channel('lessons-changes')
                    .on('postgres_changes', 
                        { event: '*',schema:'public',table:'lessons' }, 
                        () => loadLessons().then(renderLessonsRange)
                    )
                    .subscribe()
            ];
        }
        /* -------------------------
           UI FUNCTIONS
        ------------------------- */
        function openApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appRoot').style.display = 'flex';
            document.getElementById('currentUser').textContent = currentUser.email;
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attDate').value = today;
            document.getElementById('lsDate').value = today;
            document.getElementById('mtDate').value = today;
            // Load data and setup UI
            loadAllData();
            setupRealtimeUpdates();
            // Show dashboard by default
            navigate('dashboard');
            // Update clock
            updateClock();
            setInterval(updateClock,60000);
        }
        function updateClock() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString();
        }
        function showStatus(message,type = 'info') {
            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = message;
            statusEl.style.color = type === 'error' ? 'var(--danger)' : 'var(--muted)';
            setTimeout(() => {
                statusEl.textContent = '';
            },3000);
        }
        function navigate(section) {
            // Hide all sections
            document.querySelectorAll('main > section').forEach(sec => {
                sec.classList.add('hidden');
            });
            // Show the selected section
            document.getElementById(section).classList.remove('hidden');
            // Load section-specific data
            if (section === 'students') renderStudents();
            if (section === 'attendance') renderAttendanceForDate();
            if (section === 'meetings') renderMeetingsRange();
            if (section === 'lessons') {
                populateStudentSelect();
                renderLessonsRange();
            }
        }
        function refreshAll() {
            refreshSummary();
            renderStudents();
            renderAttendanceForDate();
            renderMeetingsRange();
            renderLessonsRange();
        }
        function refreshSummary() {
            document.getElementById('totalStudents').textContent = currentData.students.length;
            // Count unique attendance dates
            const uniqueDates = new Set(currentData.attendance.map(a => a.date));
            document.getElementById('attendanceDays').textContent = uniqueDates.size;
            document.getElementById('meetingsCount').textContent = currentData.meetings.length;
            document.getElementById('lessonsCount').textContent = currentData.lessons.length;
        }
        function renderStudents() {
            const tbody = document.getElementById('studentsTable').querySelector('tbody');
            tbody.innerHTML = '';
            const searchTerm = (document.getElementById('studentSearch').value || '').toLowerCase();
            currentData.students.forEach((student, index) => {
                if (searchTerm && 
                    !student.name.toLowerCase().includes(searchTerm)&&
                    !(student.grade || '').toLowerCase().includes(searchTerm)) {
                    return;
                }
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHtml(student.name)}</td>
                    <td>${student.age || ''}</td>
                    <td>${escapeHtml(student.grade || '')}</td>
                    <td>${escapeHtml(student.level || '')}</td>
                    <td>
                        <button class="action-btn edit" onclick="editStudent(${index})">Edit</button>
                        <button class="action-btn del"onclick="deleteStudent(${index})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        function populateStudentSelect() {
            const select = document.getElementById('lsStudent');
            select.innerHTML = '<option value="">--choose student--</option>';
            currentData.students.forEach((student, index) => {
                const option = document.createElement('option');
                option.value = student.name;
                option.textContent = student.name;
                select.appendChild(option);
            });
        }
        function populateParticipantSelect() {
            const select = document.getElementById('mtParticipants');
            select.innerHTML = '';
            currentData.students.forEach((student, index) => {
                const option = document.createElement('option');
                option.value = student.name;
                option.textContent = student.name;
                select.appendChild(option);
            });
        }
        async function loadAttendanceForDate() {
            const date = document.getElementById('attDate').value;
            if (!date) {
                showStatus('Please select a date first','error');
                return;
            }
            currentAttendanceDate = date;
            renderAttendanceForDate();
            showStatus(`Loaded attendance for ${date}`);
        }
        function renderAttendanceForDate() {
            const tbody = document.getElementById('attendanceTable').querySelector('tbody');
            tbody.innerHTML = '';
            if (!currentAttendanceDate) {
                currentAttendanceDate = document.getElementById('attDate').value;
            }
            // Get attendance for the selected date
            const dateAttendance = currentData.attendance.filter(a => a.date === currentAttendanceDate);
            // Create a map of student->status for this date
            const statusMap = {};
            dateAttendance.forEach(a => {
                statusMap[a.student] = a.status;
            });
            // Render each student with their status
            currentData.students.forEach(student => {
                const row = document.createElement('tr');
                const status = statusMap[student.name] || 'Absent';
                row.innerHTML = `
                    <td>${currentAttendanceDate}</td>
                    <td>${escapeHtml(student.name)}</td>
                    <td>
                        <select onchange="updateAttendanceStatus('${student.name}',this.value)">
                            <option value="Present" ${status === 'Present' ? 'selected' : ''}>Present</option>
                            <option value="Absent" ${status === 'Absent' ? 'selected' : ''}>Absent</option>
                            <option value="Holiday" ${status === 'Holiday' ? 'selected' : ''}>Holiday</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        function updateAttendanceStatus(studentName,status) {
            // This will be saved when the user clicks "Save Attendance"
            showStatus(`Marked ${studentName} as ${status}`);
        }
        function markAll(status) {
            const selects = document.querySelectorAll('#attendanceTable select');
            selects.forEach(select => {
                select.value = status;
            });
            showStatus(`Marked all students as ${status}`);
        }
        async function loadAttendanceRange() {
            const startDate = document.getElementById('attStart').value;
            const endDate = document.getElementById('attEnd').value;
            if (!startDate || !endDate) {
                showStatus('Please select both start and end dates','error');
                return;
            }
            try {
                const { data, error } = await supabase
                    .from('attendance')
                    .select('*')
                    .gte('date',startDate)
                    .lte('date',endDate)
                    .order('date',{ascending:false});
                if (error) {
                    console.error('Error loading attendance range:',error);
                    showStatus('Error loading attendance range','error');
                } else {
                    // Display the results in the table
                    const tbody = document.getElementById('attendanceTable').querySelector('tbody');
                    tbody.innerHTML = '';
                    data.forEach(record => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${record.date}</td>
                            <td>${escapeHtml(record.student)}</td>
                            <td>${record.status}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    showStatus(`Loaded ${data.length} attendance records from ${startDate} to ${endDate}`);
                }
            } catch (error) {
                console.error('Error loading attendance range:',error);
                showStatus('Error loading attendance range','error');
            }
        }
        function editStudent(index) {
            const student = currentData.students[index];
            document.getElementById('stuName').value = student.name || '';
            document.getElementById('stuAge').value = student.age || '';
            document.getElementById('stuGrade').value = student.grade || '';
            document.getElementById('stuLevel').value = student.level || '';
            editingStudent = index;
            document.getElementById('studentEditingBadge').classList.remove('hidden');
            document.getElementById('cancelStudent').style.display = 'inline-block';
        }
        function deleteStudent(index) {
            if (confirm('Are you sure you want to delete this student?')) {
                const studentId = currentData.students[index].id;
                supabase
                    .from('students')
                    .delete()
                    .eq('id', studentId)
                    .then(() => {
                        loadStudents().then(() => {
                            renderStudents();
                            refreshSummary();
                            showStatus('Student deleted');
                        });
                    });
            }
        }
        function cancelEdit(type) {
            if (type === 'student') {
                editingStudent = null;
                document.getElementById('studentForm').reset();
                document.getElementById('studentEditingBadge').classList.add('hidden');
                document.getElementById('cancelStudent').style.display = 'none';
            } else if (type === 'meeting') {
                editingMeeting = null;
                document.getElementById('meetingForm').reset();
                actionItems = [];
                renderActionItems();
                document.getElementById('cancelMeeting').style.display = 'none';
            } else if (type === 'lesson') {
                editingLesson = null;
                document.getElementById('lessonForm').reset();
                document.getElementById('cancelLesson').style.display = 'none';
            }
        }
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        // Meeting minutes functions
        function addActionItem() {
            const text = document.getElementById('aiText').value;
            const owner = document.getElementById('aiOwner').value;
            const due = document.getElementById('aiDue').value;
            const status = document.getElementById('aiStatus').value;
            if (!text) {
                showStatus('Please enter action item description','error');
                return;
            }
            actionItems.push({
                text,
                owner,
                due,
                status
            });
            renderActionItems();
            // Clear the form
            document.getElementById('aiText').value = '';
            document.getElementById('aiOwner').value = '';
            document.getElementById('aiDue').value = '';
            document.getElementById('aiStatus').value = 'Open';
            showStatus('Action item added');
        }
        function renderActionItems() {
            const tbody = document.getElementById('actionsTable').querySelector('tbody');
            tbody.innerHTML = '';
            actionItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${escapeHtml(item.text)}</td>
                    <td>${escapeHtml(item.owner)}</td>
                    <td>${escapeHtml(item.due)}</td>
                    <td>${escapeHtml(item.status)}</td>
                    <td>
                        <button class="action-btn del"onclick="removeActionItem(${index})">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        function removeActionItem(index) {
            actionItems.splice(index,1);
            renderActionItems();
            showStatus('Action item removed');
        }
        function renderMeetingsRange() {
            const tbody = document.getElementById('meetingsTable').querySelector('tbody');
            tbody.innerHTML = '';
            const startDate = document.getElementById('mtStart').value;
            const endDate = document.getElementById('mtEnd').value;
            currentData.meetings.forEach((meeting, index) => {
                if ((startDate && meeting.date < startDate)|| (endDate && meeting.date > endDate)) {
                    return;
                }
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${meeting.date}</td>
                    <td>${escapeHtml(meeting.title)}</td>
                    <td>${escapeHtml(Array.isArray(meeting.participants) ? meeting.participants.join(', ') : meeting.participants)}</td>
                    <td>
                        <button class="action-btn edit"onclick="editMeeting(${index})">Edit</button>
                        <button class="action-btn del"onclick="deleteMeeting(${index})">Delete</button>
                        <button class="action-btn link"onclick="exportSingleMeetingPDF(${index})">PDF</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        function editMeeting(index) {
            const meeting = currentData.meetings[index];
            document.getElementById('mtDate').value = meeting.date || '';
            document.getElementById('mtStartTime').value = meeting.start_time || '';
            document.getElementById('mtEndTime').value = meeting.end_time || '';
            document.getElementById('mtTitle').value = meeting.title || '';
            document.getElementById('mtLocation').value = meeting.location || '';
            document.getElementById('mtChair').value = meeting.chair || '';
            document.getElementById('mtAgenda').value = meeting.agenda || '';
            document.getElementById('mtDecisions').value = meeting.decisions || '';
            // Handle participants
            if (Array.isArray(meeting.participants)) {
                document.getElementById('mtParticipantsFree').value = meeting.participants.join(', ');
            } else {
                document.getElementById('mtParticipantsFree').value = meeting.participants || '';
            }
            // Set action items
            actionItems = meeting.actions || [];
            renderActionItems();
            editingMeeting = index;
            document.getElementById('cancelMeeting').style.display = 'inline-block';
        }
        async function deleteMeeting(index) {
            if (confirm('Are you sure you want to delete this meeting?')) {
                const meetingId = currentData.meetings[index].id;
                try {
                    const { error } = await supabase
                        .from('meetings')
                        .delete()
                        .eq('id',meetingId);
                    if (error) {
                        console.error('Error deleting meeting:',error);
                        showStatus('Error deleting meeting','error');
                    } else {
                        await loadMeetings();
                        renderMeetingsRange();
                        refreshSummary();
                        showStatus('Meeting deleted');
                    }
                } catch (error) {
                    console.error('Error deleting meeting:',error);
                    showStatus('Error deleting meeting','error');
                }
            }
        }
        function renderLessonsRange() {
            const tbody = document.getElementById('lessonsTable').querySelector('tbody');
            tbody.innerHTML = '';
            const startDate = document.getElementById('lsStart').value;
            const endDate = document.getElementById('lsEnd').value;
            currentData.lessons.forEach((lesson, index) => {
                if ((startDate && lesson.date < startDate)|| (endDate && lesson.date > endDate)) {
                    return;
                }
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${lesson.date}</td>
                    <td>${escapeHtml(lesson.student)}</td>
                    <td>${escapeHtml(lesson.subject)}</td>
                    <td>${escapeHtml(lesson.topic)}</td>
                    <td>
                        <button class="action-btn edit"onclick="editLesson(${index})">Edit</button>
                        <button class="action-btn del"onclick="deleteLesson(${index})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        function editLesson(index) {
            const lesson = currentData.lessons[index];
            document.getElementById('lsDate').value = lesson.date || '';
            document.getElementById('lsStudent').value = lesson.student || '';
            document.getElementById('lsSubject').value = lesson.subject || '';
            document.getElementById('lsTopic').value = lesson.topic || '';
            document.getElementById('lsObjectives').value = lesson.objectives || '';
            document.getElementById('lsMaterials').value = lesson.materials || '';
            document.getElementById('lsActivities').value = lesson.activities || '';
            document.getElementById('lsHomework').value = lesson.homework || '';
            editingLesson = index;
            document.getElementById('cancelLesson').style.display = 'inline-block';
        }
        async function deleteLesson(index) {
            if (confirm('Are you sure you want to delete this lesson?')) {
                const lessonId = currentData.lessons[index].id;
                try {
                    const { error } = await supabase
                        .from('lessons')
                        .delete()
                        .eq('id',lessonId);
                    if (error) {
                        console.error('Error deleting lesson:',error);
                        showStatus('Error deleting lesson','error');
                    } else {
                        await loadLessons();
                        renderLessonsRange();
                        refreshSummary();
                        showStatus('Lesson deleted');
                    }
                } catch (error) {
                    console.error('Error deleting lesson:',error);
                    showStatus('Error deleting lesson','error');
                }
            }
        }
        // Export functions
        function exportStudentsCSV() {
            try {
                const worksheet = XLSX.utils.json_to_sheet(currentData.students);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet,"Students");
                XLSX.writeFile(workbook,"students.csv");
                showStatus('Students exported to CSV');
            } catch (error) {
                console.error('Error exporting CSV:',error);
                showStatus('Error exporting CSV','error');
            }
        }
        function exportAttendanceExcel() {
            try {
                const worksheet = XLSX.utils.json_to_sheet(currentData.attendance);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet,"Attendance");
                XLSX.writeFile(workbook,"attendance.xlsx");
                showStatus('Attendance exported to Excel');
            } catch (error) {
                console.error('Error exporting Excel:',error);
                showStatus('Error exporting Excel','error');
            }
        }
        function exportMeetingsRangePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                let yPosition = 40;
                // Header
                doc.setFontSize(22);
                doc.setTextColor(10, 40, 60);
                doc.setFont("helvetica","bold");
                doc.text("GEMS Milandhoo School",pageWidth / 2,20,{align:"center"});
                doc.setFontSize(18);
                doc.setTextColor(30, 30, 30);
                doc.setFont("helvetica","normal");
                doc.text("Meeting Minutes Report",pageWidth / 2,30,{align:"center"});
                const startDate = document.getElementById('mtStart').value;
                const endDate = document.getElementById('mtEnd').value;
                doc.setFontSize(11);
                doc.setTextColor(100, 100, 100);
                doc.text(`Date Range: ${startDate||'Start'} — ${endDate||'End'}`,pageWidth / 2,36,{align:"center"});
                const filteredMeetings = currentData.meetings.filter(meeting => {
                    return (!startDate || meeting.date >= startDate)&&(!endDate || meeting.date<=endDate);
                });
                if (filteredMeetings.length === 0) {
                    doc.setFontSize(14);
                    doc.setTextColor(150, 150, 150);
                    doc.text("No meetings found for the selected date range.",pageWidth / 2,50,{align:"center"});
                    doc.save("meeting_minutes_report.pdf");
                    showStatus('Meeting minutes exported to PDF');
                    return;
                }
                filteredMeetings.forEach((meeting, index) => {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 20;
                        doc.setFontSize(22);
                        doc.setTextColor(10, 40, 60);
                        doc.setFont("helvetica","bold");
                        doc.text("GEMS Milandhoo School",pageWidth / 2,20,{align:"center"});
                        doc.setFontSize(16);
                        doc.setTextColor(30, 30, 30);
                        doc.text("Meeting Minutes",pageWidth / 2,30,{align:"center"});
                        yPosition = 40;
                    }
                    // Meeting details table
                    const meetingDetails = [
                        ["Meeting Title", meeting.title || ""],
                        ["Date", meeting.date || ""],
                        ["Time", `${meeting.start_time || ""} - ${meeting.end_time || ""}`],
                        ["Location", meeting.location || ""],
                        ["Student", meeting.chair || ""]
                    ];
                    // Draw meeting details table
                    doc.autoTable({
                        startY: yPosition,
                        head: [["Meeting Details", ""]],
                        body: meetingDetails,
                        theme: 'grid',
                        styles: {
                            cellPadding: 4,
                            fontSize: 10,
                        },
                        headStyles: {
                            fillColor: [10, 40, 60],
                            textColor: 255,
                            fontStyle: 'bold',
                        },
                        bodyStyles: {
                            valign: 'top',
                        },
                        columnStyles: {
                            0: { cellWidth: 40, fontStyle: 'bold' },
                            1: { cellWidth: 'auto' }
                        },
                    });
                    yPosition = doc.lastAutoTable.finalY + 10;
                    // Participants section
                    const participants = Array.isArray(meeting.participants) ? meeting.participants : [];
                    const participantRows = participants.map(p => [p]);
                    if (participantRows.length > 0) {
                        doc.autoTable({
                            startY: yPosition,
                            head: [["Participants"]],
                            body: participantRows,
                            theme: 'grid',
                            styles: {
                                cellPadding: 4,
                                fontSize: 10,
                            },
                            headStyles: {
                                fillColor: [10, 40, 60],
                                textColor: 255,
                                fontStyle: 'bold',
                            },
                        });
                        yPosition = doc.lastAutoTable.finalY + 10;
                    }
                    // Agenda section
                    if (meeting.agenda) {
                        doc.setFontSize(12);
                        doc.setFont("helvetica", "bold");
                        doc.text("Agenda:", 14, yPosition);
                        yPosition += 6;
                        doc.setFontSize(10);
                        doc.setFont("helvetica", "normal");
                        const agendaLines = doc.splitTextToSize(meeting.agenda, pageWidth - 28);
                        doc.text(agendaLines, 14, yPosition);
                        yPosition += (agendaLines.length * 5) + 8;
                    }
                    // Decisions section
                    if (meeting.decisions) {
                        doc.setFontSize(12);
                        doc.setFont("helvetica", "bold");
                        doc.text("Key Decisions:", 14, yPosition);
                        yPosition += 6;
                        doc.setFontSize(10);
                        doc.setFont("helvetica", "normal");
                        const decisionLines = doc.splitTextToSize(meeting.decisions, pageWidth - 28);
                        doc.text(decisionLines, 14, yPosition);
                        yPosition += (decisionLines.length * 5) + 8;
                    }
                    // Action items table
                    if (meeting.actions && meeting.actions.length > 0) {
                        const actionItemsData = meeting.actions.map((item, idx) => [
                            idx + 1,
                            item.text || "",
                            item.owner || "",
                            item.due || "",
                            item.status || ""
                        ]);
                        doc.autoTable({
                            startY: yPosition,
                            head: [["#", "Action Item", "Owner", "Due Date", "Status"]],
                            body: actionItemsData,
                            theme: 'grid',
                            styles: {
                                cellPadding: 3,
                                fontSize: 9,
                            },
                            headStyles: {
                                fillColor: [10, 40, 60],
                                textColor: 255,
                                fontStyle: 'bold',
                            },
                            columnStyles: {
                                0: { cellWidth: 10 },
                                1: { cellWidth: 60 },
                                2: { cellWidth: 30 },
                                3: { cellWidth: 25 },
                                4: { cellWidth: 20 }
                            },
                        });
                        yPosition = doc.lastAutoTable.finalY + 15;
                    }
                    // Signature section
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.text("Prepared by:", 14, yPosition);
                    doc.text("Approved by:", pageWidth - 60, yPosition);
                    yPosition += 20;
                    doc.setDrawColor(0, 0, 0);
                    doc.line(14, yPosition, 80, yPosition); // Prepared by line
                    doc.line(pageWidth - 60, yPosition, pageWidth - 14, yPosition); // Approved by line
                    yPosition += 10;
                    doc.setFontSize(8);
                    doc.setFont("helvetica", "normal");
                    doc.text("Name & Signature", 14, yPosition);
                    doc.text("Leading Teacher", pageWidth - 60, yPosition);
                    yPosition += 20;
                });
                // Footer with page numbers
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.setTextColor(120, 120, 120);
                    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 290);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth - 14, 290, {align: "right"});
                }
                doc.save("meeting_minutes_report.pdf");
                showStatus('Meeting minutes exported to PDF');
            } catch (error) {
                console.error('Error exporting PDF:',error);
                showStatus('Error exporting PDF','error');
            }
        }
        function exportLessonsPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                let yPosition = 40;
                // Header
                doc.setFontSize(22);
                doc.setTextColor(10, 40, 60);
                doc.setFont("helvetica","bold");
                doc.text("GEMS Milandhoo School",pageWidth / 2,20,{align:"center"});
                doc.setFontSize(18);
                doc.setTextColor(30, 30, 30);
                doc.setFont("helvetica","normal");
                doc.text("Lesson Plan Report",pageWidth / 2,30,{align:"center"});
                const startDate = document.getElementById('lsStart').value;
                const endDate = document.getElementById('lsEnd').value;
                doc.setFontSize(11);
                doc.setTextColor(100, 100, 100);
                doc.text(`Date Range: ${startDate||'Start'} — ${endDate||'End'}`,pageWidth / 2,36,{align:"center"});
                const filteredLessons = currentData.lessons.filter(lesson => {
                    return (!startDate || lesson.date >= startDate)&&(!endDate || lesson.date<=endDate);
                });
                if (filteredLessons.length === 0) {
                    doc.setFontSize(14);
                    doc.setTextColor(150, 150, 150);
                    doc.text("No lesson plans found for the selected date range.",pageWidth / 2,50,{align:"center"});
                    doc.save("lesson_plans_report.pdf");
                    showStatus('Lesson plans exported to PDF');
                    return;
                }
                filteredLessons.forEach((lesson, index) => {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 20;
                        doc.setFontSize(22);
                        doc.setTextColor(10, 40, 60);
                        doc.setFont("helvetica","bold");
                        doc.text("GEMS Milandhoo School",pageWidth / 2,20,{align:"center"});
                        doc.setFontSize(16);
                        doc.setTextColor(30, 30, 30);
                        doc.text("Lesson Plan",pageWidth / 2,30,{align:"center"});
                        yPosition = 40;
                    }
                    // Lesson details table
                    const lessonDetails = [
                        ["Student", lesson.student || ""],
                        ["Date", lesson.date || ""],
                        ["Subject", lesson.subject || ""],
                        ["Topic", lesson.topic || ""]
                    ];
                    // Draw lesson details table
                    doc.autoTable({
                        startY: yPosition,
                        head: [["Lesson Details", ""]],
                        body: lessonDetails,
                        theme: 'grid',
                        styles: {
                            cellPadding: 4,
                            fontSize: 10,
                        },
                        headStyles: {
                            fillColor: [10, 40, 60],
                            textColor: 255,
                            fontStyle: 'bold',
                        },
                        bodyStyles: {
                            valign: 'top',
                        },
                        columnStyles: {
                            0: { cellWidth: 30, fontStyle: 'bold' },
                            1: { cellWidth: 'auto' }
                        },
                    });
                    yPosition = doc.lastAutoTable.finalY + 10;
                    // Objectives section
                    if (lesson.objectives) {
                        doc.setFontSize(12);
                        doc.setFont("helvetica", "bold");
                        doc.text("Learning Objectives:", 14, yPosition);
                        yPosition += 6;
                        doc.setFontSize(10);
                        doc.setFont("helvetica", "normal");
                        const objectiveLines = doc.splitTextToSize(lesson.objectives, pageWidth - 28);
                        doc.text(objectiveLines, 14, yPosition);
                        yPosition += (objectiveLines.length * 5) + 8;
                    }
                    // Materials section
                    if (lesson.materials) {
                        doc.setFontSize(12);
                        doc.setFont("helvetica", "bold");
                        doc.text("Materials/Resources:", 14, yPosition);
                        yPosition += 6;
                        doc.setFontSize(10);
                        doc.setFont("helvetica", "normal");
                        const materialLines = doc.splitTextToSize(lesson.materials, pageWidth - 28);
                        doc.text(materialLines, 14, yPosition);
                        yPosition += (materialLines.length * 5) + 8;
                    }
                    // Activities section
                    if (lesson.activities) {
                        doc.setFontSize(12);
                        doc.setFont("helvetica", "bold");
                        doc.text("Activities:", 14, yPosition);
                        yPosition += 6;
                        doc.setFontSize(10);
                        doc.setFont("helvetica", "normal");
                        const activityLines = doc.splitTextToSize(lesson.activities, pageWidth - 28);
                        doc.text(activityLines, 14, yPosition);
                        yPosition += (activityLines.length * 5) + 8;
                    }
                    // Homework section
                    if (lesson.homework) {
                        doc.setFontSize(12);
                        doc.setFont("helvetica", "bold");
                        doc.text("Homework/Assessment:", 14, yPosition);
                        yPosition += 6;
                        doc.setFontSize(10);
                        doc.setFont("helvetica", "normal");
                        const homeworkLines = doc.splitTextToSize(lesson.homework, pageWidth - 28);
                        doc.text(homeworkLines, 14, yPosition);
                        yPosition += (homeworkLines.length * 5) + 15;
                    }
                    // Signature section
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.text("Prepared by:", 14, yPosition);
                    doc.text("Approved by:", pageWidth - 60, yPosition);
                    yPosition += 20;
                    doc.setDrawColor(0, 0, 0);
                    doc.line(14, yPosition, 80, yPosition); // Prepared by line
                    doc.line(pageWidth - 60, yPosition, pageWidth - 14, yPosition); // Approved by line
                    yPosition += 10;
                    doc.setFontSize(8);
                    doc.setFont("helvetica", "normal");
                    doc.text("Teacher's Name & Signature", 14, yPosition);
                    doc.text("Leading Teacher", pageWidth - 60, yPosition);
                    yPosition += 20;
                });
                // Footer with page numbers
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.setTextColor(120, 120, 120);
                    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 290);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth - 14, 290, {align: "right"});
                }
                doc.save("lesson_plans_report.pdf");
                showStatus('Lesson plans exported to PDF');
            } catch (error) {
                console.error('Error exporting PDF:',error);
                showStatus('Error exporting PDF','error');
            }
        }
        function exportSingleMeetingPDF(index) {
            try {
                const meeting = currentData.meetings[index];
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                let yPosition = 40;
                // Header
                doc.setFontSize(22);
                doc.setTextColor(10, 40, 60);
                doc.setFont("helvetica","bold");
                doc.text("GEMS Milandhoo School",pageWidth / 2,20,{align:"center"});
                doc.setFontSize(18);
                doc.setTextColor(30, 30, 30);
                doc.setFont("helvetica","normal");
                doc.text("Meeting Minutes",pageWidth / 2,30,{align:"center"});
                // Meeting details table
                const meetingDetails = [
                    ["Meeting Title", meeting.title || ""],
                    ["Date", meeting.date || ""],
                    ["Time", `${meeting.start_time || ""} - ${meeting.end_time || ""}`],
                    ["Location", meeting.location || ""],
                    ["Student", meeting.chair || ""]
                ];
                // Draw meeting details table
                doc.autoTable({
                    startY: yPosition,
                    head: [["Meeting Details", ""]],
                    body: meetingDetails,
                    theme: 'grid',
                    styles: {
                        cellPadding: 4,
                        fontSize: 10,
                    },
                    headStyles: {
                        fillColor: [10, 40, 60],
                        textColor: 255,
                        fontStyle: 'bold',
                    },
                    bodyStyles: {
                        valign: 'top',
                    },
                    columnStyles: {
                        0: { cellWidth: 40, fontStyle: 'bold' },
                        1: { cellWidth: 'auto' }
                    },
                });
                yPosition = doc.lastAutoTable.finalY + 10;
                // Participants section
                const participants = Array.isArray(meeting.participants) ? meeting.participants : [];
                const participantRows = participants.map(p => [p]);
                if (participantRows.length > 0) {
                    doc.autoTable({
                        startY: yPosition,
                        head: [["Participants"]],
                        body: participantRows,
                        theme: 'grid',
                        styles: {
                            cellPadding: 4,
                            fontSize: 10,
                        },
                        headStyles: {
                            fillColor: [10, 40, 60],
                            textColor: 255,
                            fontStyle: 'bold',
                        },
                    });
                    yPosition = doc.lastAutoTable.finalY + 10;
                }
                // Agenda section
                if (meeting.agenda) {
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text("Agenda:", 14, yPosition);
                    yPosition += 6;
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    const agendaLines = doc.splitTextToSize(meeting.agenda, pageWidth - 28);
                    doc.text(agendaLines, 14, yPosition);
                    yPosition += (agendaLines.length * 5) + 8;
                }
                // Decisions section
                if (meeting.decisions) {
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text("Key Decisions:", 14, yPosition);
                    yPosition += 6;
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    const decisionLines = doc.splitTextToSize(meeting.decisions, pageWidth - 28);
                    doc.text(decisionLines, 14, yPosition);
                    yPosition += (decisionLines.length * 5) + 8;
                }
                // Action items table
                if (meeting.actions && meeting.actions.length > 0) {
                    const actionItemsData = meeting.actions.map((item, idx) => [
                        idx + 1,
                        item.text || "",
                        item.owner || "",
                        item.due || "",
                        item.status || ""
                    ]);
                    doc.autoTable({
                        startY: yPosition,
                        head: [["#", "Action Item", "Owner", "Due Date", "Status"]],
                        body: actionItemsData,
                        theme: 'grid',
                        styles: {
                            cellPadding: 3,
                            fontSize: 9,
                            overflow: 'linebreak'
                        },
                        headStyles: {
                            fillColor: [10, 40, 60],
                            textColor: 255,
                            fontStyle: 'bold',
                        },
                        columnStyles: {
                            0: { cellWidth: 10 },
                            1: { cellWidth: 60 },
                            2: { cellWidth: 30 },
                            3: { cellWidth: 25 },
                            4: { cellWidth: 20 }
                        },
                    });
                    yPosition = doc.lastAutoTable.finalY + 15;
                }
                // Signature section
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.text("Prepared by:", 14, yPosition);
                doc.text("Approved by:", pageWidth - 60, yPosition);
                yPosition += 20;
                doc.setDrawColor(0, 0, 0);
                doc.line(14, yPosition, 80, yPosition); // Prepared by line
                doc.line(pageWidth - 60, yPosition, pageWidth - 14, yPosition); // Approved by line
                yPosition += 10;
                doc.setFontSize(8);
                doc.setFont("helvetica", "normal");
                doc.text("Name & Signature", 14, yPosition);
                doc.text("Leading Teacher", pageWidth - 60, yPosition);
                // Footer with page number
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.setTextColor(120, 120, 120);
                    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 290);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth - 14, 290, {align: "right"});
                }
                doc.save(`meeting_${meeting.date}.pdf`);
                showStatus('Meeting minutes exported to PDF');
            } catch (error) {
                console.error('Error exporting PDF:',error);
                showStatus('Error exporting PDF','error');
            }
        }
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            setupAuth();
            // Set up form handlers
            document.getElementById('studentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const studentData = {
                    name: document.getElementById('stuName').value.trim(),
                    age: parseInt(document.getElementById('stuAge').value) || 0,
                    grade: document.getElementById('stuGrade').value.trim(),
                    level: document.getElementById('stuLevel').value.trim()
                };
                if (!studentData.name) {
                    alert('Please enter a student name');
                    return;
                }
                if (await saveStudents()) {
                    showStatus('Student saved successfully');
                    cancelEdit('student');
                    renderStudents();
                    refreshSummary();
                }
            });
            // Set up meeting form handler
            document.getElementById('meetingForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!document.getElementById('mtDate').value || !document.getElementById('mtTitle').value) {
                    alert('Please enter date and title');
                    return;
                }
                if (await saveMeetings()) {
                    showStatus('Meeting saved successfully');
                    actionItems = [];
                    renderActionItems();
                    renderMeetingsRange();
                    refreshSummary();
                    document.getElementById('meetingForm').reset();
                    document.getElementById('cancelMeeting').style.display = 'none';
                    editingMeeting = null;
                }
            });
            // Set up lesson form handler
            document.getElementById('lessonForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!document.getElementById('lsDate').value || !document.getElementById('lsStudent').value || 
                    !document.getElementById('lsSubject').value || !document.getElementById('lsTopic').value) {
                    alert('Please enter date, student, subject, and topic');
                    return;
                }
                if (await saveLessons()) {
                    showStatus('Lesson saved successfully');
                    renderLessonsRange();
                    refreshSummary();
                    document.getElementById('lessonForm').reset();
                    document.getElementById('cancelLesson').style.display = 'none';
                    editingLesson = null;
                }
            });
            // Set today's dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attDate').value = today;
            document.getElementById('lsDate').value = today;
            document.getElementById('mtDate').value = today;
            // Make functions global for HTML onclick attributes
            window.navigate = navigate;
            window.logout = logout;
            window.editStudent = editStudent;
            window.deleteStudent = deleteStudent;
            window.cancelEdit = cancelEdit;
            window.renderStudents = renderStudents;
            window.addActionItem = addActionItem;
            window.removeActionItem = removeActionItem;
            window.loadAttendanceForDate = loadAttendanceForDate;
            window.saveAttendance = saveAttendance;
            window.markAll = markAll;
            window.loadAttendanceRange = loadAttendanceRange;
            window.exportAttendanceExcel = exportAttendanceExcel;
            window.loadMeetingsRange = renderMeetingsRange;
            window.exportMeetingsRangePDF = exportMeetingsRangePDF;
            window.loadLessonsRange = renderLessonsRange;
            window.exportLessonsPDF = exportLessonsPDF;
            window.exportStudentsCSV = exportStudentsCSV;
            window.exportSingleMeetingPDF = exportSingleMeetingPDF;
            window.editMeeting = editMeeting;
            window.deleteMeeting = deleteMeeting;
            window.editLesson = editLesson;
            window.deleteLesson = deleteLesson;
        });
    </script>
</body>
</html>
